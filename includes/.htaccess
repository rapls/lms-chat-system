# SSE (Server-Sent Events) 用の設定
# Xserver環境でのSSE接続を確実にするための設定

# SSEファイルへのアクセスを許可
<Files "sse.php">
    Order Allow,Deny
    Allow from all
</Files>

# ディレクトリリスティングを無効化
Options -Indexes

# SSE専用の詳細設定
<FilesMatch "sse\.php$">
    # バッファリングを無効化（Xserver環境用）
    SetEnv no-gzip 1
    SetEnv no-cache 1
    SetEnv no-brotli 1
    SetEnv proxy-nokeepalive 1
    
    # PHP設定（利用可能な場合）
    <IfModule mod_php.c>
        php_value max_execution_time 180
        php_value max_input_time 180
        php_value memory_limit 128M
        php_flag output_buffering off
        php_flag zlib.output_compression off
        php_flag session.auto_start off
        php_value session.cache_limiter none
    </IfModule>
    
    # PHP7+の設定（利用可能な場合）
    <IfModule mod_php7.c>
        php_value max_execution_time 180
        php_value max_input_time 180
        php_value memory_limit 128M
        php_flag output_buffering off
        php_flag zlib.output_compression off
        php_flag session.auto_start off
        php_value session.cache_limiter none
    </IfModule>
</FilesMatch>

# HTTPヘッダー設定（SSE用）
<IfModule mod_headers.c>
    <FilesMatch "sse\.php$">
        # Content-Type設定（重要）
        Header set Content-Type "text/event-stream; charset=UTF-8"
        
        # キャッシュ無効化
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
        
        # 接続設定
        Header set Connection "keep-alive"
        
        # Xserver/nginx環境用のバッファリング無効化
        Header set X-Accel-Buffering "no"
        Header set X-Nginx-Buffering "no"
        
        # CORS設定（min-s.orgドメイン用）
        SetEnvIf Origin "https?://(www\.)?(lms\.)?min-s\.org(:\d+)?$" ORIGIN_SUB_DOMAIN=$0
        Header set Access-Control-Allow-Origin "%{ORIGIN_SUB_DOMAIN}e" env=ORIGIN_SUB_DOMAIN
        Header set Access-Control-Allow-Credentials "true"
        Header set Access-Control-Allow-Headers "Cache-Control, X-Requested-With"
        Header set Access-Control-Max-Age "3600"
    </FilesMatch>
</IfModule>

# ping.phpへのアクセスも許可
<Files "ping.php">
    Order Allow,Deny
    Allow from all
</Files>

# SSE AJAX Wrapper用設定を追加
<Files "sse-ajax-wrapper.php">
    Order Allow,Deny
    Allow from all
</Files>

<FilesMatch "sse-ajax-wrapper\.php$">
    SetEnv no-gzip 1
    SetEnv no-cache 1
    <IfModule mod_php.c>
        php_value max_execution_time 180
        php_flag output_buffering off
    </IfModule>
</FilesMatch>

# その他のファイルへのアクセスを拒否（セキュリティ）
<FilesMatch "^(?!(sse|ping|sse-ajax-wrapper)\.php).*$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# 設定ファイルへのアクセスを明示的に拒否
<FilesMatch "\.(inc|config|log)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>
