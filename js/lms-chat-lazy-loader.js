/**
 * LMS Chat ÈÅÖÂª∂Ë™≠„ÅøËæº„Åø„Ç∑„Çπ„ÉÜ„É†
 * ÂàùÊúüË°®Á§∫ÈÄüÂ∫¶„ÇíÂ§ßÂπÖ„Å´Âêë‰∏ä„Åï„Åõ„ÇãËªΩÈáè„É≠„Éº„ÉÄ„Éº
 */
(function() {
    'use strict';

    window.LMSChatLazyLoader = {
        initialized: false,
        loadQueue: [],
        
        // üöÄ ËªΩÈáèÂàùÊúüÂåñÔºàÂç≥Â∫ß„Å´ÂÆüË°å„Åï„Çå„ÇãÊúÄÂ∞èÈôê„ÅÆÂá¶ÁêÜÔºâ
        initLightweight: function() {
            if (this.initialized) return;
            this.initialized = true;
            
            // Âü∫Êú¨ÁöÑ„Å™„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÅÆ„ÅøË®≠ÂÆö
            this.setupBasicEvents();
            
            // ÂøÖË¶Å„Å™Ë¶ÅÁ¥†„ÅÆÈÅÖÂª∂ÂàùÊúüÂåñ
            setTimeout(() => this.initializeComponents(), 100);
            
            // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Ê©üËÉΩ„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„Åø
            setTimeout(() => this.loadReactionSystem(), 2000);
            
            // Ê§úÁ¥¢Ê©üËÉΩ„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„Åø
            setTimeout(() => this.loadSearchSystem(), 3000);
        },
        
        // Âü∫Êú¨„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÉºË®≠ÂÆö
        setupBasicEvents: function() {
            // „ÉÅ„É£„É≥„Éç„É´Âàá„ÇäÊõø„Åà„ÅÆÂü∫Êú¨ÁöÑ„Å™Âá¶ÁêÜ„ÅÆ„Åø
            document.addEventListener('click', (e) => {
                const channelItem = e.target.closest('.channel-item');
                if (channelItem) {
                    this.handleChannelSwitch(channelItem);
                }
            });
            
            // „É°„Éã„É•„Éº„ÅÆÂü∫Êú¨Âá¶ÁêÜ
            const menuButton = document.getElementById('chatMenuButton');
            const menuContent = document.getElementById('chatMenuContent');
            if (menuButton && menuContent) {
                menuButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    menuContent.classList.toggle('show');
                });
            }
        },
        
        // „ÉÅ„É£„É≥„Éç„É´Âàá„ÇäÊõø„Åà„ÅÆËªΩÈáèÂá¶ÁêÜ
        handleChannelSwitch: function(channelItem) {
            const channelId = channelItem.getAttribute('data-channel-id');
            const channelType = channelItem.getAttribute('data-channel-type');
            
            // „Ç¢„Ç§„Ç≥„É≥Â§âÊõ¥„ÅÆÂü∫Êú¨Âá¶ÁêÜ
            const iconContainer = document.querySelector('.channel-header-icon');
            const hashIcon = document.querySelector('.channel-header-icon .icon-hash');
            const lockIcon = document.querySelector('.channel-header-icon .icon-lock');
            
            if (channelType === 'public') {
                if (iconContainer) iconContainer.style.display = 'flex';
                if (hashIcon) hashIcon.style.display = 'block';
                if (lockIcon) lockIcon.style.display = 'none';
            } else if (channelType === 'private') {
                if (iconContainer) iconContainer.style.display = 'flex';
                if (hashIcon) hashIcon.style.display = 'none';
                if (lockIcon) lockIcon.style.display = 'block';
            }
            
            // ÂÆüÈöõ„ÅÆ„ÉÅ„É£„É≥„Éç„É´Ë™≠„ÅøËæº„Åø„ÅØÂà•ÈÄîÂÆüË°å
            if (window.LMSChat && window.LMSChat.ui && window.LMSChat.ui.switchChannel) {
                window.LMSChat.ui.switchChannel(channelId);
            }
        },
        
        // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆÂàùÊúüÂåñ
        initializeComponents: function() {
            // „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÅÆÈÅÖÂª∂ÂàùÊúüÂåñ
            if (window.lmsPushConfig) {
                window.lmsPush = Object.freeze(window.lmsPushConfig);
            }
            
            // Service Worker „Ç§„Éô„É≥„Éà„ÅÆË®≠ÂÆö
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'NOTIFICATION_CLICK') {
                        this.handleNotificationClick(event.data);
                    }
                });
            }
            
            // ÈÄöÁü•„Éú„Çø„É≥„ÅÆË®≠ÂÆö
            this.setupNotificationButton();
        },
        
        // ÈÄöÁü•„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        handleNotificationClick: function(data) {
            if (data.channelId && typeof switchChannel === 'function') {
                switchChannel(parseInt(data.channelId));
                
                if (data.messageId) {
                    setTimeout(() => {
                        const message = document.querySelector(`.chat-message[data-message-id="${data.messageId}"]`);
                        if (message) {
                            const container = document.querySelector('.chat-messages');
                            if (container) {
                                container.scrollTop = message.offsetTop - container.offsetTop;
                                message.classList.add('highlight-message');
                                setTimeout(() => message.classList.remove('highlight-message'), 3000);
                            }
                        }
                    }, 500);
                }
            }
        },
        
        // ÈÄöÁü•„Éú„Çø„É≥„ÅÆË®≠ÂÆö
        setupNotificationButton: function() {
            const enableNotificationsButton = document.getElementById('enableNotificationsButton');
            if (!enableNotificationsButton) return;
            
            const updateButtonStyle = () => {
                if (Notification.permission === 'granted') {
                    enableNotificationsButton.classList.add('enabled');
                    const span = enableNotificationsButton.querySelector('span');
                    if (span) span.textContent = '„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÅØÊúâÂäπ„Åß„Åô';
                } else {
                    enableNotificationsButton.classList.remove('enabled');
                    const span = enableNotificationsButton.querySelector('span');
                    if (span) span.textContent = '„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã';
                }
            };
            
            updateButtonStyle();
            
            enableNotificationsButton.addEventListener('click', async (e) => {
                e.preventDefault();
                if (window.pushNotification && typeof window.pushNotification.setupPushSubscription === 'function') {
                    await window.pushNotification.setupPushSubscription();
                    updateButtonStyle();
                    const menuContent = document.getElementById('chatMenuContent');
                    if (menuContent) menuContent.classList.remove('show');
                }
            });
            
            if ('Notification' in window) {
                setInterval(updateButtonStyle, 2000);
            }
        },
        
        // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„Åø
        loadReactionSystem: function() {
            if (window.LMSChat && window.LMSChat.reactions) return; // Êó¢„Å´Ë™≠„ÅøËæº„ÅøÊ∏à„Åø
            
            // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Èñ¢ÈÄ£„ÅÆCSSËøΩÂä†
            this.addReactionStyles();
            
            // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Ê©üËÉΩ„ÅÆÂü∫Êú¨ÂàùÊúüÂåñ
            setTimeout(() => {
                if (window.LMSChat && window.LMSChat.reactions && window.LMSChat.reactions.init) {
                    window.LMSChat.reactions.init();
                }
            }, 500);
        },
        
        // Ê§úÁ¥¢„Ç∑„Çπ„ÉÜ„É†„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„Åø
        loadSearchSystem: function() {
            // Ê§úÁ¥¢„Éú„Çø„É≥„ÅÆÂèØË¶ñÊÄßÁ¢∫‰øù
            this.ensureSearchButtonVisible();
            
            // Ê§úÁ¥¢Èñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
            const searchInput = document.getElementById('chat-search-input');
            const searchButton = document.getElementById('chat-search-button');
            
            if (searchInput) {
                searchInput.addEventListener('focus', () => this.ensureSearchButtonVisible());
                searchInput.addEventListener('click', () => this.ensureSearchButtonVisible());
            }
            
            if (searchButton) {
                this.addSearchButtonStyles();
            }
        },
        
        // Ê§úÁ¥¢„Éú„Çø„É≥„ÅÆÂèØË¶ñÊÄßÁ¢∫‰øù
        ensureSearchButtonVisible: function() {
            const searchBtn = document.getElementById('chat-search-button');
            if (!searchBtn) return;
            
            searchBtn.style.setProperty('display', 'flex', 'important');
            searchBtn.style.setProperty('visibility', 'visible', 'important');
            searchBtn.style.setProperty('opacity', '1', 'important');
            searchBtn.style.setProperty('position', 'absolute', 'important');
            searchBtn.style.setProperty('left', '10px', 'important');
            searchBtn.style.setProperty('top', '50%', 'important');
            searchBtn.style.setProperty('transform', 'translateY(-50%)', 'important');
            searchBtn.style.setProperty('z-index', '9999', 'important');
            searchBtn.style.setProperty('width', '20px', 'important');
            searchBtn.style.setProperty('height', '20px', 'important');
        },
        
        // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Áî®„Çπ„Çø„Ç§„É´ËøΩÂä†
        addReactionStyles: function() {
            if (document.getElementById('reaction-styles')) return; // Êó¢„Å´ËøΩÂä†Ê∏à„Åø
            
            const style = document.createElement('style');
            style.id = 'reaction-styles';
            style.textContent = `
                .reaction-item {
                    display: inline-block !important;
                    margin: 2px !important;
                    padding: 4px 8px !important;
                    background: #f5f5f5 !important;
                    border-radius: 12px !important;
                    cursor: pointer !important;
                    border: 1px solid #ddd !important;
                    user-select: none !important;
                    transition: background-color 0.2s ease !important;
                }
                .reaction-item.user-reacted {
                    background: #e3f2fd !important;
                    border-color: #2196f3 !important;
                }
                .reaction-item:hover {
                    background: #e8e8e8 !important;
                }
            `;
            document.head.appendChild(style);
        },
        
        // Ê§úÁ¥¢„Éú„Çø„É≥Áî®„Çπ„Çø„Ç§„É´ËøΩÂä†
        addSearchButtonStyles: function() {
            if (document.getElementById('search-button-styles')) return; // Êó¢„Å´ËøΩÂä†Ê∏à„Åø
            
            const style = document.createElement('style');
            style.id = 'search-button-styles';
            style.textContent = `
                .chat-search-button, #chat-search-button {
                    position: absolute !important;
                    left: 10px !important;
                    top: 50% !important;
                    transform: translateY(-50%) !important;
                    background: none !important;
                    border: none !important;
                    padding: 0 !important;
                    cursor: pointer !important;
                    color: #666 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    height: 20px !important;
                    width: 20px !important;
                    z-index: 10 !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                }
                .chat-search-button:hover, #chat-search-button:hover {
                    color: #333 !important;
                }
                .chat-search-input, #chat-search-input {
                    padding-left: 35px !important;
                }
            `;
            document.head.appendChild(style);
        }
    };

    // DOMContentLoadedÊôÇ„Åæ„Åü„ÅØÂç≥Â∫ß„Å´ËªΩÈáèÂàùÊúüÂåñ„ÇíÂÆüË°å
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            // Á∑äÊÄ•„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: 5ÁßíÈÅÖÂª∂
            setTimeout(() => {
                window.LMSChatLazyLoader.initLightweight();
            }, 5000);
        });
    } else {
        window.LMSChatLazyLoader.initLightweight();
    }

    // LMSChatLoader „Å®„ÅÆÁµ±Âêà
    if (window.LMSChatLoader) {
        window.LMSChatLoader.initLightweight = () => window.LMSChatLazyLoader.initLightweight();
    }
})();