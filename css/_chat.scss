/**
 * LMS チャット未読管理システム用 SCSS
 * 新規メッセージのNewマーク、未読バッジ、スレッド返信数のスタイル
 */

// ====================
// NEW マークスタイル
// ====================

// 基本的な New マーク（user-nameの後に配置される）
.new-mark {
    background: linear-gradient(45deg, #ff4757, #ff3742);
    color: white;
    font-size: 9px;
    font-weight: bold;
    padding: 1px 4px;
    border-radius: 8px;
    margin-left: 6px;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    box-shadow: 0 1px 2px rgba(255, 71, 87, 0.3);
    animation: newMarkPulse 1.5s infinite ease-in-out;
    vertical-align: middle;
    
    // アクセシビリティ対応
    user-select: none;
    cursor: default;
    
    // フェードアウト時のトランジション
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    
    // ホバー効果
    &:hover {
        background: linear-gradient(45deg, #ff3742, #ff2730);
        transform: scale(1.05);
    }
}

// New マークアニメーション
@keyframes newMarkPulse {
    0% { 
        transform: scale(1); 
        opacity: 1; 
    }
    50% { 
        transform: scale(1.05); 
        opacity: 0.9; 
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
    }
    100% { 
        transform: scale(1); 
        opacity: 1; 
    }
}

// スレッド内の New マーク（小さめ）
.thread-info .new-mark,
.thread-message .new-mark {
    font-size: 8px;
    padding: 1px 4px;
    border-radius: 8px;
    margin-left: 4px;
    background: linear-gradient(45deg, #0052cc, #0065d9);
    color: #ffffff;
    border: 1px solid rgba(0, 82, 204, 0.3);
}

// ====================
// has-new-mark クラス付きメッセージのスタイル
// ====================

.chat-message.has-new-mark,
.thread-message.has-new-mark,
.message-item.has-new-mark {
    background: linear-gradient(to right, 
        rgba(255, 107, 107, 0.05) 0%, 
        rgba(255, 107, 107, 0.02) 100%
    );
    border-left: 3px solid #ff6b6b;
    padding-left: calc(1rem - 3px);
    transition: all 0.3s ease;
    position: relative;
    
    // 微細な影でメッセージを強調
    box-shadow: 0 1px 3px rgba(255, 107, 107, 0.1);
    
    &:hover {
        background: linear-gradient(to right, 
            rgba(255, 107, 107, 0.08) 0%, 
            rgba(255, 107, 107, 0.03) 100%
        );
    }
}

// New マーク付きメッセージのメタデータスタイル
.chat-message.has-new-mark .message-meta,
.thread-message.has-new-mark .message-meta,
.message-item.has-new-mark .message-meta,
.chat-message.has-new-mark .thread-message-meta,
.thread-message.has-new-mark .thread-message-meta {
    color: #333;
    font-weight: 500;
    
    .message-time {
        color: #ff6b6b;
        font-weight: 600;
    }
    
    .user-name {
        color: #2c3e50;
        font-weight: 600;
    }
}

// ====================
// 未読バッジスタイル
// ====================

.unread-badge {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: bold;
    display: inline-block;
    min-width: 16px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
    animation: badgePulse 2s infinite ease-in-out;
    
    // 0の場合は非表示
    &:empty,
    &[data-count="0"] {
        display: none;
    }
}

// バッジのパルスアニメーション
@keyframes badgePulse {
    0%, 100% { 
        transform: scale(1); 
        opacity: 1;
    }
    50% { 
        transform: scale(1.1); 
        opacity: 0.8;
        box-shadow: 0 2px 8px rgba(231, 76, 60, 0.5);
    }
}

// ヘッダーチャットアイコンの未読バッジ
.chat-icon .unread-badge,
.header-chat-icon .unread-badge,
.chat-icon-wrapper .unread-badge {
    position: absolute !important;
    top: -8px !important;
    right: -8px !important;
    background: #ff4757 !important;
    color: white !important;
    font-size: 10px !important;
    font-weight: bold !important;
    min-width: 16px !important;
    padding: 2px 6px !important;
    border: 2px solid white !important;
    border-radius: 10px !important;
    box-shadow: 0 2px 6px rgba(255, 71, 87, 0.4) !important;
    text-align: center !important;
    line-height: 1 !important;
    z-index: 9999 !important;
    display: inline-block !important;
    
    // 0または空の場合は非表示
    &:empty,
    &[data-count="0"] {
        display: none !important;
    }
}

// チャットアイコンの親要素を相対配置に
.chat-icon-wrapper,
.chat-icon {
    position: relative !important;
}

// チャンネル未読バッジ
.channel-unread-badge,
.channel-item .unread-badge {
    margin-left: 8px;
    background: linear-gradient(45deg, #3742fa, #2f3542);
    font-size: 9px;
    padding: 1px 5px;
}

// スレッド未読バッジ
.thread-unread-badge,
.thread-info .unread-badge {
    margin-left: 6px;
    background: linear-gradient(45deg, #26de81, #20bf6b);
    font-size: 8px;
    padding: 1px 4px;
    border-radius: 8px;
}

// 緊急対応用の絶対配置Newマーク
.emergency-new-mark {
    position: absolute;
    top: 5px;
    right: 5px;
    background: linear-gradient(45deg, #ff4757, #ff3742) !important;
    color: white !important;
    padding: 2px 6px !important;
    border-radius: 10px !important;
    font-size: 10px !important;
    font-weight: bold !important;
    z-index: 1000 !important;
    animation: newMarkPulse 1.5s infinite ease-in-out !important;
    box-shadow: 0 2px 6px rgba(255, 71, 87, 0.4) !important;
    text-transform: uppercase !important;
    letter-spacing: 0.3px !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

// 強制表示バッジ
.force-channel-badge {
    background: #ff4444 !important;
    display: inline-block !important;
    animation: forceChannelBadge 0.5s ease-out;
}

.force-thread-badge {
    background: #007cba !important;
    display: inline-block !important;
    animation: forceThreadBadge 0.5s ease-out;
}

// 緊急対応バッジ
.emergency-global-badge,
.absolute-channel-badge,
.absolute-thread-badge {
    position: fixed;
    background: #ff4444;
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-weight: bold;
    z-index: 9999;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: emergencyBadge 0.8s ease-out;
}

.emergency-global-badge {
    top: 20px;
    right: 20px;
}

.absolute-channel-badge {
    background: #007cba;
    top: 60px;
    right: 20px;
}

.absolute-thread-badge {
    background: #007cba;
    top: 100px;
    right: 20px;
}

// 緊急対応スレッド返信数
.emergency-thread-count {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: #007cba;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    z-index: 999;
    animation: emergencyThread 0.5s ease-out;
}

// 追加のアニメーション
@keyframes forceChannelBadge {
    0% {
        transform: scale(0.8);
        opacity: 0;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes forceThreadBadge {
    0% {
        transform: scale(0.8);
        opacity: 0;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes emergencyBadge {
    0% {
        transform: translateX(100%) scale(0.8);
        opacity: 0;
    }
    100% {
        transform: translateX(0) scale(1);
        opacity: 1;
    }
}

@keyframes emergencyThread {
    0% {
        transform: scale(0.5);
        opacity: 0;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

// ====================
// スレッド返信数スタイル
// ====================

.reply-count,
.thread-replies-count,
.thread-count {
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 500;
    margin-left: 8px;
    display: inline-block;
    
    &::before {
        content: "💬";
        margin-right: 4px;
        font-size: 10px;
    }
    
    // ホバー時の強調
    .thread-info:hover & {
        color: #34495e;
        font-weight: 600;
    }
}

// ====================
// スレッド情報エリアのスタイル
// ====================

.thread-info {
    padding: 8px 12px;
    background: rgba(52, 73, 94, 0.05);
    border-radius: 8px;
    margin-top: 8px;
    border-left: 3px solid #bdc3c7;
    transition: all 0.3s ease;
    
    &:hover {
        background: rgba(52, 73, 94, 0.08);
        border-left-color: #34495e;
    }
    
    // 未読がある場合の強調
    &.has-unread {
        border-left-color: #26de81;
        background: rgba(38, 222, 129, 0.08);
        
        .reply-count {
            color: #20bf6b;
            font-weight: 600;
        }
    }
}

// ====================
// レスポンシブ対応
// ====================

@media (max-width: 768px) {
    .new-mark {
        font-size: 9px;
        padding: 1px 4px;
        margin-left: 6px;
    }
    
    .unread-badge {
        font-size: 9px;
        padding: 1px 4px;
        min-width: 14px;
    }
    
    .reply-count {
        font-size: 11px;
        margin-left: 6px;
    }
}

@media (max-width: 480px) {
    .new-mark {
        font-size: 8px;
        padding: 1px 3px;
        margin-left: 4px;
    }
    
    .unread-badge {
        font-size: 8px;
        padding: 1px 3px;
        min-width: 12px;
    }
    
    .thread-info {
        padding: 6px 8px;
        margin-top: 6px;
    }
    
    .reply-count {
        font-size: 10px;
        margin-left: 4px;
    }
}

// ====================
// アクセシビリティとダークモード対応
// ====================

// ダークモード対応（プリファーされた場合）
@media (prefers-color-scheme: dark) {
    .chat-message.has-new-mark,
    .thread-message.has-new-mark,
    .message-item.has-new-mark {
        background: linear-gradient(to right, 
            rgba(255, 107, 107, 0.1) 0%, 
            rgba(255, 107, 107, 0.05) 100%
        );
        border-left-color: #ff7979;
    }
    
    .thread-info {
        background: rgba(255, 255, 255, 0.1);
        border-left-color: #7f8c8d;
        
        &:hover {
            background: rgba(255, 255, 255, 0.15);
        }
    }
    
    .reply-count {
        color: #bdc3c7;
    }
}

// 高コントラストモード対応
@media (prefers-contrast: high) {
    .new-mark {
        background: #d63031;
        border: 1px solid #fff;
        font-weight: 900;
    }
    
    .unread-badge {
        background: #e17055;
        border: 1px solid #fff;
    }
}

// アニメーション無効設定に対応
@media (prefers-reduced-motion: reduce) {
    .new-mark,
    .unread-badge {
        animation: none;
    }
    
    .chat-message.has-new-mark,
    .thread-message.has-new-mark,
    .message-item.has-new-mark {
        transition: none;
    }
}

// ====================
// フォーカス状態（キーボードアクセシビリティ）
// ====================

.thread-info:focus,
.thread-toggle:focus {
    outline: 2px solid #74b9ff;
    outline-offset: 2px;
    border-radius: 4px;
}

// ====================
// ヘッダーチャットアイコン未読バッジ
// ====================

.site-header {
    .chat-icon-wrapper {
        position: relative;
        display: inline-block;
        z-index: 9998;
        
        .chat-icon {
            position: relative;
            display: inline-block;
            padding: 8px;
            transition: transform 0.2s ease;
            z-index: 9998;
            
            &:hover {
                transform: scale(1.1);
            }
            
            img {
                width: 32px;
                height: 32px;
                transition: filter 0.2s ease;
                
                .chat-icon:hover & {
                    filter: brightness(1.2);
                }
            }
            
            // ヘッダーバッジ（最重要）
            .unread-badge {
                position: absolute;
                top: 0;
                right: 0;
                background: linear-gradient(45deg, #ff4757, #ff3742);
                color: white !important;
                border-radius: 50%;
                min-width: 20px;
                min-height: 20px;
                font-size: 11px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
                z-index: 9999 !important;
                box-shadow: 0 2px 8px rgba(255, 71, 87, 0.5);
                border: 2px solid white;
                transform: translate(50%, -50%);
                text-align: center;
                vertical-align: middle;
                
                // テキスト要素の確実な表示
                &, & * {
                    color: white !important;
                    z-index: 9999 !important;
                    position: relative;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                }
                
                // デフォルトで非表示
                opacity: 0;
                visibility: hidden;
                transform: translate(50%, -50%) scale(0);
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                
                // 空の場合は最優先で非表示（最重要ルール）
                &:empty {
                    display: none !important;
                    opacity: 0 !important;
                    visibility: hidden !important;
                    transform: translate(50%, -50%) scale(0) !important;
                    background: none !important;
                    border: none !important;
                    box-shadow: none !important;
                    width: 0 !important;
                    height: 0 !important;
                    min-width: 0 !important;
                    min-height: 0 !important;
                }
                
                // 表示状態（テキストがある場合のみ）
                &.visible:not(:empty),
                &.show:not(:empty),
                &.has-content:not(:empty) {
                    display: flex !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    transform: translate(50%, -50%) scale(1) !important;
                    color: white !important;
                    background: linear-gradient(45deg, #ff4757, #ff3742) !important;
                    border-radius: 50% !important;
                    min-width: 20px !important;
                    min-height: 20px !important;
                    font-size: 11px !important;
                    font-weight: bold !important;
                    align-items: center !important;
                    justify-content: center !important;
                    line-height: 1 !important;
                    z-index: 99999 !important;
                    box-shadow: 0 2px 8px rgba(255, 71, 87, 0.5) !important;
                    border: 2px solid white !important;
                    text-align: center !important;
                    vertical-align: middle !important;
                    
                    // 内部テキストの強制表示
                    &::before,
                    &::after {
                        content: none;
                    }
                }
                
                // アニメーション効果
                &.visible {
                    animation: headerBadgeBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                }
                
                // ホバー効果
                &:hover {
                    transform: translate(50%, -50%) scale(1.1);
                    background: linear-gradient(45deg, #ff3742, #ff2730);
                    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.7);
                }
                
                // 数字が2桁以上の場合
                &.multi-digit {
                    min-width: 24px;
                    padding: 0 4px;
                    border-radius: 12px;
                }
            }
        }
    }
}

// バッジアニメーション
@keyframes headerBadgeBounce {
    0% {
        opacity: 0;
        transform: translate(50%, -50%) scale(0);
    }
    50% {
        opacity: 1;
        transform: translate(50%, -50%) scale(1.2);
    }
    100% {
        opacity: 1;
        transform: translate(50%, -50%) scale(1);
    }
}

// バッジ点滅アニメーション（新着時）
@keyframes headerBadgePulse {
    0%, 100% {
        box-shadow: 0 2px 8px rgba(255, 71, 87, 0.5);
    }
    50% {
        box-shadow: 0 4px 16px rgba(255, 71, 87, 0.8);
        transform: translate(50%, -50%) scale(1.05);
    }
}

// 新着メッセージ時の点滅
.site-header .chat-icon-wrapper .chat-icon .unread-badge.new-message {
    animation: headerBadgePulse 1.5s ease-in-out 3;
}

// レスポンシブ対応
@media (max-width: 768px) {
    .site-header .chat-icon-wrapper {
        .chat-icon {
            padding: 6px;
            
            img {
                width: 28px;
                height: 28px;
            }
            
            .unread-badge {
                min-width: 18px;
                min-height: 18px;
                font-size: 10px;
                
                &.multi-digit {
                    min-width: 22px;
                    padding: 0 3px;
                    border-radius: 11px;
                }
            }
        }
    }
}

// 空のバッジを確実に非表示にする最優先ルール
.site-header .chat-icon-wrapper .chat-icon .unread-badge:empty {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transform: translate(50%, -50%) scale(0) !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    width: 0 !important;
    height: 0 !important;
    min-width: 0 !important;
    min-height: 0 !important;
}

// 空のバッジが visible や show クラスを持っていても強制的に非表示
.site-header .chat-icon-wrapper .chat-icon .unread-badge.visible:empty,
.site-header .chat-icon-wrapper .chat-icon .unread-badge.show:empty,
.site-header .chat-icon-wrapper .chat-icon .unread-badge.visible.show:empty {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transform: translate(50%, -50%) scale(0) !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    width: 0 !important;
    height: 0 !important;
    min-width: 0 !important;
    min-height: 0 !important;
}

// フォールバック用の強制表示クラス（テキストがある場合のみ）
.force-show-header-badge {
    .site-header .chat-icon-wrapper .chat-icon .unread-badge:not(:empty) {
        opacity: 1 !important;
        visibility: visible !important;
        display: flex !important;
        transform: translate(50%, -50%) scale(1) !important;
        color: white !important;
        z-index: 99999 !important;
    }
}

// ヘッダーバッジ専用クラス（競合回避）
.site-header .chat-icon-wrapper .chat-icon .unread-badge.header-badge,
.site-header .chat-icon-wrapper .chat-icon .unread-badge.universal-header-badge {
    color: white !important;
    background: linear-gradient(45deg, #ff4757, #ff3742) !important;
    z-index: 99999 !important;
    
    // 数字の表示を最優先
    &, &:before, &:after, & * {
        color: white !important;
        z-index: 99999 !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5) !important;
    }
}

// 全般的なバッジテキスト表示の強化
.unread-badge {
    // 空のバッジは絶対に表示しない（最強ルール）
    &:empty {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        min-width: 0 !important;
        min-height: 0 !important;
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        transform: scale(0) !important;
    }
    
    &.visible,
    &.show {
        // 空でない場合のみ表示
        &:not(:empty) {
            color: white !important;
            // テキストノードの強制表示
            text-indent: 0 !important;
            text-decoration: none !important;
            overflow: visible !important;
            white-space: nowrap !important;
        }
        
        // 空の場合は強制非表示
        &:empty {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
    }
}

// unread-badge-hide クラス（最強の非表示ルール）
.unread-badge-hide {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    width: 0 !important;
    height: 0 !important;
    min-width: 0 !important;
    min-height: 0 !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    transform: scale(0) !important;
}

// unread-badge-hide が付いていればどんなクラス組み合わせでも非表示
.unread-badge.unread-badge-hide,
.unread-badge.visible.unread-badge-hide,
.unread-badge.show.unread-badge-hide,
.unread-badge.has-content.unread-badge-hide,
.unread-badge.visible.show.unread-badge-hide,
.unread-badge.visible.show.has-content.unread-badge-hide {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    width: 0 !important;
    height: 0 !important;
    min-width: 0 !important;
    min-height: 0 !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    transform: scale(0) !important;
}

// 最強の空バッジ非表示ルール（セレクター詳細度を最大に）
body .site-header .header-container .chat-icon-wrapper .chat-icon .unread-badge:empty,
body .site-header .chat-icon-wrapper .chat-icon .unread-badge.visible:empty,
body .site-header .chat-icon-wrapper .chat-icon .unread-badge.show:empty,
body .site-header .chat-icon-wrapper .chat-icon .unread-badge.header-badge:empty,
body .site-header .chat-icon-wrapper .chat-icon .unread-badge.universal-header-badge:empty {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    width: 0 !important;
    height: 0 !important;
    min-width: 0 !important;
    min-height: 0 !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    transform: scale(0) !important;
}

// ====================
// インフィニティスクロール プレミアムフェードインアニメーション
// ====================

// 高品質なメッセージスライドインキーフレーム
@keyframes premiumMessageSlideIn {
    0% {
        opacity: 0;
        transform: translate3d(0, -30px, 0) scale(0.92) rotateX(10deg);
        filter: blur(3px) brightness(0.8) contrast(0.9);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0);
    }
    25% {
        opacity: 0.3;
        transform: translate3d(0, -18px, 0) scale(0.95) rotateX(6deg);
        filter: blur(1.8px) brightness(0.85) contrast(0.95);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05);
    }
    60% {
        opacity: 0.8;
        transform: translate3d(0, -6px, 0) scale(0.98) rotateX(2deg);
        filter: blur(0.8px) brightness(0.92) contrast(0.98);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    85% {
        opacity: 0.95;
        transform: translate3d(0, -2px, 0) scale(1.01) rotateX(0deg);
        filter: blur(0.2px) brightness(0.96) contrast(1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    100% {
        opacity: 1;
        transform: translate3d(0, 0, 0) scale(1) rotateX(0deg);
        filter: blur(0) brightness(1) contrast(1);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }
}

// 日付セパレーター用の軽やかなアニメーション
@keyframes premiumSeparatorSlideIn {
    0% {
        opacity: 0;
        transform: translate3d(0, -20px, 0) scale(0.95);
        filter: blur(2px) brightness(0.9);
    }
    50% {
        opacity: 0.6;
        transform: translate3d(0, -8px, 0) scale(0.98);
        filter: blur(0.8px) brightness(0.94);
    }
    100% {
        opacity: 1;
        transform: translate3d(0, 0, 0) scale(1);
        filter: blur(0) brightness(1);
    }
}

// プレミアムフェードイン効果 - メッセージ用（!important で既存CSS上書き）
#chat-messages .chat-message.infinity-scroll-new-message {
    // ハードウェアアクセラレーション有効化
    will-change: transform, opacity, filter !important;
    
    // 初期状態 - より洗練された設定
    &.fade-in-ready {
        opacity: 0 !important;
        transform: translate3d(0, -30px, 0) scale(0.92) rotateX(10deg) !important;
        filter: blur(3px) brightness(0.8) contrast(0.9) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0) !important;
        transition: none !important;
        animation: none !important;
        backface-visibility: hidden !important;
        perspective: 1000px !important;
    }
    
    // アニメーション実行状態（よりゆっくり）
    &.fade-in-active {
        animation: premiumMessageSlideIn 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards !important;
        transition: none !important;
    }
    
    // 完了後の状態（最適化）
    &.fade-in-complete {
        will-change: auto !important;
        transform: translate3d(0, 0, 0) scale(1) rotateX(0deg) !important;
        filter: blur(0) brightness(1) contrast(1) !important;
        opacity: 1 !important;
        animation: none !important;
        transition: none !important;
    }
}

// プレミアムフェードイン効果 - 日付セパレーター用（!important で上書き）
#chat-messages .date-separator {
    will-change: transform, opacity, filter !important;
    
    &.fade-in-ready {
        opacity: 0 !important;
        transform: translate3d(0, -20px, 0) scale(0.95) !important;
        filter: blur(2px) brightness(0.9) !important;
        transition: none !important;
        animation: none !important;
        backface-visibility: hidden !important;
    }
    
    &.fade-in-active {
        animation: premiumSeparatorSlideIn 1.5s cubic-bezier(0.16, 1, 0.3, 1) forwards !important;
        transition: none !important;
    }
    
    &.fade-in-complete {
        will-change: auto !important;
        transform: translate3d(0, 0, 0) scale(1) !important;
        filter: blur(0) brightness(1) !important;
        opacity: 1 !important;
        animation: none !important;
        transition: none !important;
    }
}

// 特別なマイクロインタラクション効果（!important で上書き）
#chat-messages .chat-message.infinity-scroll-new-message.fade-in-active {
    // 微細な光沢効果
    &::after {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: -100% !important;
        width: 100% !important;
        height: 100% !important;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.15) 50%,
            transparent
        ) !important;
        animation: shimmerEffect 2.5s ease-out 0.5s !important;
        pointer-events: none !important;
        z-index: 1 !important;
    }
}

@keyframes shimmerEffect {
    0% {
        left: -100%;
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
    100% {
        left: 100%;
        opacity: 0;
    }
}

// レスポンシブ対応 - モバイル用最適化（!important で上書き）
@media (max-width: 768px) {
    #chat-messages .chat-message.infinity-scroll-new-message.fade-in-ready {
        transform: translate3d(0, -20px, 0) scale(0.95) !important;
        filter: blur(2px) brightness(0.85) !important;
    }
    
    #chat-messages .chat-message.infinity-scroll-new-message.fade-in-active {
        animation-duration: 1.6s !important;
    }
}

// 低スペック端末用の軽量版（!important で上書き）
@media (prefers-reduced-motion: reduce) {
    #chat-messages .chat-message.infinity-scroll-new-message.fade-in-active,
    #chat-messages .date-separator.fade-in-active {
        animation: none !important;
        transition: opacity 0.3s ease-out, transform 0.3s ease-out !important;
        opacity: 1 !important;
        transform: translate3d(0, 0, 0) scale(1) rotateX(0deg) !important;
        filter: none !important;
    }
}

// ====================
// デバッグ用スタイル（開発時のみ）
// ====================

// .debug-unread-system {
//     .has-new-mark {
//         border: 2px dashed #ff6b6b !important;
//     }
//     
//     .new-mark {
//         border: 1px solid yellow !important;
//     }
//     
//     .unread-badge {
//         border: 1px solid lime !important;
//     }
// }