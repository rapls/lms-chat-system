# 統合ロングポーリングシステム テストガイド

## 🧪 テスト環境について

統合ロングポーリングシステムの実装が完了しました。このシステムは従来の6秒間隔のショートポーリングを、効率的な30秒間隔のロングポーリングに置き換えます。

## 📋 実装済みコンポーネント

### バックエンド
- ✅ `class-lms-unified-longpoll.php` - 統合ロングポーリングエンドポイント
- ✅ `class-lms-migration-controller.php` - 段階的移行制御システム
- ✅ データベーステーブル最適化
- ✅ イベント管理システム

### フロントエンド
- ✅ `lms-unified-longpoll.js` - 統合ロングポーリングクライアント
- ✅ `longpoll-test.js` - 開発者用テストツール
- ✅ 4レベルフォールバック機能

### 管理画面
- ✅ `longpoll-migration-admin.php` - 移行管理インターフェース
- ✅ ヘルスメトリクス監視
- ✅ ベータユーザー管理

## 🚀 テスト開始手順

### 1. Local環境の起動
```bash
# Local by Flywheel を起動
# lms2 サイトを開始
```

### 2. WordPress管理画面にアクセス
```
URL: http://lms2.local/wp-admin/
```

### 3. ロングポーリング移行管理ページにアクセス
```
ツール > ロングポーリング移行
```

### 4. ベータテストの有効化

管理画面で以下を設定：

1. **移行ステージを「ベータテスト」に変更**
2. **現在のユーザーをベータユーザーに追加**
3. **全フィーチャーフラグを有効化**

### 5. フロントエンド テストツールの使用

チャット画面で以下のキーボードショートカットを使用：

```
Ctrl + Shift + T
```

テストパネルが表示され、以下のテストが実行できます：

- 📋 基本構造チェック
- ⚙️ 設定チェック
- 🔗 接続テスト
- 🔄 フォールバックテスト

## 🔍 テスト項目

### Phase 1: 基本動作確認

#### 1.1 システム初期化テスト
- [ ] WordPress読み込み時にエラーが発生しないか
- [ ] 統合ロングポーリングクラスが正しく読み込まれるか
- [ ] マイグレーションコントローラーが動作するか

#### 1.2 設定確認テスト
- [ ] `lmsLongPollConfig` オブジェクトが正しく出力されるか
- [ ] ベータユーザー判定が正しく動作するか
- [ ] フィーチャーフラグが反映されるか

#### 1.3 管理画面テスト
- [ ] 移行管理ページが正しく表示されるか
- [ ] ステージ変更が動作するか
- [ ] ベータユーザー追加/削除が動作するか
- [ ] フィーチャーフラグ切り替えが動作するか

### Phase 2: 接続・通信テスト

#### 2.1 ロングポーリング接続テスト
- [ ] 30秒間の接続が確立されるか
- [ ] 接続タイムアウト後に再接続されるか
- [ ] 複数タブでの接続制限（最大3接続）が動作するか

#### 2.2 イベント配信テスト
- [ ] メッセージ送信イベントが配信されるか
- [ ] リアクション追加イベントが配信されるか
- [ ] スレッド作成イベントが配信されるか

#### 2.3 フォールバック機能テスト
- [ ] サーバーエラー時にmediumポーリング（15秒）に切り替わるか
- [ ] 継続エラー時にshortポーリング（6秒）に切り替わるか
- [ ] 重大エラー時にemergencyポーリング（3秒）に切り替わるか

### Phase 3: パフォーマンステスト

#### 3.1 レスポンス時間測定
- [ ] 平均レスポンス時間が2秒以下か
- [ ] エラー率が5%以下か
- [ ] 成功率が95%以上か

#### 3.2 リソース使用量測定
- [ ] メモリ使用量が制限内か
- [ ] データベース接続数が適切か
- [ ] サーバー負荷が軽減されているか

### Phase 4: 互換性テスト

#### 4.1 既存機能との互換性
- [ ] 従来のメッセージ送受信が動作するか
- [ ] リアクション機能が正常に動作するか
- [ ] スレッド機能が正常に動作するか
- [ ] 検索機能が正常に動作するか

#### 4.2 ブラウザ互換性
- [ ] Chrome での動作確認
- [ ] Safari での動作確認
- [ ] Firefox での動作確認

## 🔧 デバッグ方法

### 1. ブラウザコンソールでの確認

```javascript
// 基本情報の確認
LongPollSystemTester.debugInfo();

// 設定の確認
console.log(lmsLongPollConfig);

// 統合ロングポーリングインスタンスの確認
console.log(window.unifiedLongPoll);
```

### 2. サーバーログの確認

```bash
# WordPress デバッグログ
tail -f /path/to/wp-content/debug.log

# 統合ロングポーリング専用ログ
tail -f /path/to/wp-content/themes/lms/longpoll-debug.log
```

### 3. データベースの確認

```sql
-- イベントテーブルの確認
SELECT * FROM wp_lms_chat_realtime_events ORDER BY timestamp DESC LIMIT 10;

-- 設定の確認
SELECT * FROM wp_options WHERE option_name LIKE 'lms_longpoll%';
```

## 🚨 トラブルシューティング

### よくある問題と解決方法

#### 1. 「LMSUnifiedLongPoll が定義されていません」エラー
**原因**: JavaScriptファイルが正しく読み込まれていない
**解決**: 
- ユーザーがログインしているか確認
- `wp_enqueue_scripts` が正しく動作しているか確認
- ファイルパスが正しいか確認

#### 2. 「データベース接続エラー」
**原因**: Local環境が起動していない、またはデータベース設定が不正
**解決**:
- Local by Flywheel でサイトを起動
- MySQL サービスが起動しているか確認

#### 3. 「権限が不足しています」エラー
**原因**: 管理者権限のないユーザーで管理画面にアクセス
**解決**:
- 管理者権限のあるユーザーでログイン
- `manage_options` 権限を確認

#### 4. ロングポーリング接続が確立されない
**原因**: サーバー設定、ファイアウォール、またはタイムアウト設定
**解決**:
- PHP の `max_execution_time` を確認
- サーバーのタイムアウト設定を確認
- エラーログを確認

## 📊 成功指標

以下の指標が達成されれば、テストは成功とみなします：

### 技術指標
- ✅ エラー率 < 5%
- ✅ 平均レスポンス時間 < 2秒
- ✅ 成功率 > 95%
- ✅ 接続確立率 > 90%

### ユーザー体験指標
- ✅ メッセージ配信遅延 < 3秒
- ✅ リアクション同期遅延 < 2秒
- ✅ 接続断絶の発生頻度 < 1回/時間

### システム効率指標
- ✅ サーバーリクエスト数削減 > 80%
- ✅ データベース負荷軽減 > 70%
- ✅ ネットワーク帯域使用量削減 > 60%

## 📋 テスト完了チェックリスト

### 基本機能テスト
- [ ] システム初期化
- [ ] 設定読み込み
- [ ] 管理画面操作
- [ ] ユーザー権限チェック

### 通信機能テスト
- [ ] ロングポーリング接続
- [ ] イベント配信
- [ ] フォールバック機能
- [ ] 接続制限

### パフォーマンステスト
- [ ] レスポンス時間測定
- [ ] エラー率測定
- [ ] リソース使用量測定
- [ ] 負荷テスト

### 互換性テスト
- [ ] 既存機能との互換性
- [ ] ブラウザ互換性
- [ ] モバイル対応

### セキュリティテスト
- [ ] 認証・認可
- [ ] XSS防止
- [ ] CSRF防止
- [ ] SQLインジェクション防止

## 📞 サポート

テスト中に問題が発生した場合：

1. **エラーログを確認**してください
2. **デバッグ情報を収集**してください  
3. **再現手順を記録**してください
4. **システム状態をスクリーンショットで保存**してください

---

**注意**: このテストガイドは開発・テスト環境でのみ使用してください。本番環境での使用前には十分なテストを実施してください。